<%
  # This partial defines the "count_n" operation. Given a set of assertions, i.e. functions defined by sub-elements in the query_structure, we
  # will check to see if at least n (where n is an integer defined within our query structure) are true. An empty list returns true.
  #
  # Locals
  # parent_id - The stored ID of the query structure element that called this partial. Used to mark variables in our outputted javascript for slightly better readabillity.
  # query_substructure - A fragment of the query structure whose top element is an "count_n" operation. Our assertions come from the associated array.
%>

function() {
  <%= render :partial => "/queries/builder/assertions", :locals => { :query_substructure => query_substructure, :parent_id => parent_id } %>

  count = 0;
  for (var i = 0; i < assertions_<%= parent_id %>.length; i++) {
    if (assertions_<%= parent_id %>[i]) {
      count++;
    }
  }
  <% # If at least n-many assertions are true, return true. If n was not defined, we use the number of assertions, so this operation defaults to the equivalent of an "and". %>
  if (count >= <%= query_substructure['n'] ||= query_substructure['count_n'].length %>) {
    return true;
  }
  else {
    return false;
  }
}