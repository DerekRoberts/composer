<h1>Query Status</h1>
<table>
  <tr><th align='left'>Title</th><td><%= @query.title %></td></tr>
  <tr><th align='left'>Description</th><td><%= @query.description %></td></tr>
  <tr><th align='left'>Filter</th><td><pre><%= @query.filter %></pre></td></tr>
  <tr><th align='left' valign='top'>Map Function</th><td><pre><%= @query.map %></pre></td></tr>
  <tr><th align='left' valign='top'>Reduce Function</th><td><pre><%= @query.reduce %></pre></td></tr>
  <tr>
    <th  align='left' valign='top'>Endpoints</th>
    <td>
      <table>
        <tr>
          <th align='left'>Query URL</th>
          <th align='left'>Status</th>
          <th align='left'>Next Poll</th>
          <th align='left'>Poll URL</th>
          <th align='left'>Result</th>
        </tr>
        <% 
          #TODO: need to add AJAX refresh 
        %>
        <% 
        if (@query.last_execution)
	        results = @query.last_execution.results unless @query.last_execution
	    else
	        results = @query.endpoints.map{|endpoint| Result.new(endpoint: endpoint)}
		end
		results.each do |result| %>
          <tr valign='top'>
            <td><%= result.endpoint.submit_url %></td>
            <td><%= result.status %></td>
            <td><%= result.next_poll %></td>
            <td><%= result.result_url %></td>
            <td>
              <table>
               <% result.value.each do |key, value| %>
                <% next if key=='_id' %>
                <tr>
                  <td><code><%= key %>:</code></td>
                  <td><code><%= jsonify(value) %></code></td>
                </tr>
                <% end if result.value %>
              </table>
            </td>
          </tr>
        <% end %>
      </table>
    </td>
  </tr>
  <% if @query.last_execution && @query.last_execution.aggregate_result %>
  <tr>
    <th align='left' valign='top'>Aggregate Result</th>
    <td>
      <table>
        <% @query.last_execution.aggregate_result.each do |key, value| %>
        <% next if key=='_id' %>
        <tr>
          <td><code><%= key %>:</code></td>
          <td><code><%= jsonify(value) %></code></td>
        </tr>
        <% end %>
      </table>
    </td>
  </tr>
  <% end %>
  <tr>
    <td></td>
    <td>
      <table>
        <tr>
          <td><%= button_to 'Edit', {:action=>'edit', :id=>@query.id}, :method=>:get %></td>
          <td><%= button_to 'Execute', {:action=>'execute', :id=>@query.id} %></td>
        </tr>
      </table>
    </td>
  </tr>
</table>

<p><%= link_to 'Query List', queries_path %> | <%= link_to 'Event Log', log_query_path %></p>